function Dialogue(d,div,optsDiv){that={};var current;var waiting=false;var callback;var callbackId;function mousePressed(e){if(waiting===true){waiting=false;forward()}}function forward(){waiting=false;div.style.display="none";optsDiv.style.display="none";div.innerHTML="";optsDiv.innerHTML="";if(current){if(typeof current.pre==="function"){try{current.pre()}catch(e){console.log("Dialogue callback failed with error "+e)}}if(typeof current.line==="string"){var x=document.getElementById(current.div)||div;say(current.line,x)}if(current.options){writeOptions(d,current.options)}else{if(current.exit){current=d[current.exit];waiting=true}else{current=undefined;waiting=true}}}else{if(callback){try{callback()}catch(e){console.log(e)}callback=null}INPUT.removeCallback("onmousedown",callbackId)}}function say(line,x){x.style.display="block";x.textContent=x.innerText=current.line}function writeOptions(dialogue,options){optsDiv.style.display="block";for(var i=0;i<options.length;i++){var current=dialogue[options[i]];if(current.condition){if(!current.condition()){continue}}var option=document.createElement("div");option.className="line";option.id=options[i];option.onmousedown=function(c){return function(){if(c.post){c.post()}selectExit(c);optsDiv.innerHTML="";optsDiv.style.display="none"}}(current);option.textContent=option.innerText="> "+current.line;optsDiv.appendChild(option)}}function selectExit(e){current=e;forward()}that.play=function(c){callbackId=INPUT.addCallback("onmousedown",mousePressed);callback=c;current=d.start;waiting=false;forward()};return that}var GAME=function(width,height){var that={};var currentScene;var currentScreen;var animationRequest;var mouseCallback;var background;var scrolling;var interactive=true;var datGui;var story,storyDiv,rootHudDiv;var currentHotspots;var charSprite;that.stage=new PIXI.Stage(65280);that.renderer=PIXI.autoDetectRenderer(width,height);that.debug=false;that.hudManager;that.STATE={act:0};that.PLAYER={knows:{}};function initDebug(s){if(!datGui){datGui=new dat.GUI}if(background){datGui.add(background.position,"x");datGui.add(background.position,"y")}}that.init=function(){rootHudDiv=document.getElementById("hud");that.hudManager=new HUD(rootHudDiv);that.load()};that.screens={};that.addScreen=function(name,code){that.screens[name]=code};that.getScreen=function(name){return that.screens[name]};that.persist=function(){try{if(window.localStorage){localStorage.setItem("game",JSON.stringify(that.STATE));localStorage.setItem("player",JSON.stringify(that.PLAYER))}}catch(e){console.log(e)}};that.load=function(){try{if(window.localStorage){var gameState=JSON.parse(localStorage.getItem("game"));var playerState=JSON.parse(localStorage.getItem("player"));if(gameState){var r=confirm("Found a saved state. Would you like to continue your previous game?");if(r){that.STATE=gameState;that.PLAYER=playerState||{knows:{}}}}}}catch(e){console.log(e)}};that.preloadingManifest=function(){var manifest=[];for(s in that.screens){if(that.screens[s].background){manifest.push(that.screens[s].background.img)}if(that.screens[s].sprites){manifest=manifest.concat(that.screens[s].sprites)}}return manifest};that.showScreen=function(futureScreen){that.persist();for(var i=0;i<that.stage.children.length;i++){that.stage.removeChild(that.stage.children[i])}that.hudManager.clear();if(currentScreen&&that.screens[currentScreen].exit){try{that.screens[currentScreen].exit();background=null}catch(e){console.log("Failed to exit screen gracefully "+e)}}currentScreen=futureScreen;var s=that.screens[currentScreen];if(s.background&&s.background.img){background=PIXI.Sprite.fromImage(s.background.img);if(s.background.scrollin){if(s.background.scrollin==="left"){background.anchor.x=1;background.position.x=GAME.renderer.width}else{background.anchor.x=0;background.position.x=0}scrolling=true;that.setInactive()}else{background.anchor.x=.5;background.position.x=GAME.renderer.width/2}background.anchor.y=.5;background.position.y=GAME.renderer.height/2;GAME.stage.addChild(background)}currentHotspots=[];if(s.hotspots){for(i in s.hotspots){var hs=s.hotspots[i];var newDiv=GAME.hudManager.addHud("hotspot"+i,hs.bottom.x-hs.top.x,hs.bottom.y-hs.top.y,hs.top.x,hs.top.y,"non-clickable");hs.div=newDiv;(function(hs){newDiv.onmousedown=function(){if(interactive){hs.callback()}}})(hs);currentHotspots.push(hs)}}if(!scrolling){screenReady(s)}cancelAnimationFrame(animationRequest);var lastTime;(function animate(timestamp){var timeDelta=timestamp-lastTime;if(scrolling){var scrollinTime=7e3;if(s.background.scrollin==="left"&&background.position.x<GAME.renderer.width+512&&timestamp&&timeDelta){background.position.x+=timeDelta/scrollinTime*512}else if(background.position.x>=GAME.renderer.width+512){scrolling=false;that.setActive();screenReady(s)}lastTime=timestamp}if(s.animate){s.animate()}animationRequest=requestAnimationFrame(animate);GAME.renderer.render(GAME.stage)})();if(mouseCallback){mouseCallback=INPUT.removeCallback("onmousedown",mouseCallback)}if(GAME.debug){initDebug(s)}};function screenReady(s){if(s.title){showTitle(s.title)}if(s.init){s.init()}}that.showDialogue=function(lines,characterImage,callback){var characterDiv=GAME.hudManager.addHud("hud-character",600,80,70,255,"options");characterDiv.style.display="none";characterDiv.height="auto";var dialogueDiv=GAME.hudManager.addHud("hud-dialogue",400,60,270,120,"dialogue");dialogueDiv.style.display="none";dialogueDiv.height="auto";story=new Dialogue(lines,dialogueDiv,characterDiv);if(characterImage){charSprite=PIXI.Sprite.fromImage(characterImage);charSprite.anchor.x=charSprite.anchor.y=1;charSprite.position.x=990;charSprite.position.y=340;GAME.stage.addChild(charSprite)}that.setInactive();story.play(function(){dialogueFinished();if(callback){try{callback()}catch(e){console.log(e)}}})};function dialogueFinished(){if(charSprite){GAME.stage.removeChild(charSprite)}charSprite=null;GAME.hudManager.removeHud("hud-character");GAME.hudManager.removeHud("hud-dialogue");that.setActive()}that.showStory=function(lines,callback){storyDiv=GAME.hudManager.addHud("hud-story",Math.floor(GAME.renderer.width*.66),80,0,GAME.renderer.height-160,"story");story=new Dialogue(lines,storyDiv,storyDiv);that.setInactive();story.play(function(){storyFinished();if(callback){try{callback()}catch(e){console.log(e)}}})};function storyFinished(){GAME.hudManager.removeHud("hud-story");that.setActive()}that.setActive=function(){interactive=true;for(hs in currentHotspots){currentHotspots[hs].div.className="clickable";if(currentHotspots[hs].title){currentHotspots[hs].div.title=currentHotspots[hs].title}}};that.setInactive=function(){interactive=false;for(hs in currentHotspots){currentHotspots[hs].div.className="non-clickable";if(currentHotspots[hs].div.title){delete currentHotspots[hs].div.removeAttribute("title")}}};function showTitle(title){titleDiv=GAME.hudManager.addHud("hud-title",1024,20,0,10,"img-title");titleDiv.style.width="100%";titleDiv.innerText=titleDiv.textContent=title;setTimeout(function(){titleDiv.style.display="none"},3500)}return that}(1024,400);function HUD(rootElement){if(!rootElement){throw"Root element must be given"}if(rootElement.style.position!=="relative"){throw"Root element must have a relative position"}var that={huds:{},defaultPosition:{}};that.defaultPosition.x=that.defaultPosition.y="0px";that.defaultColor="#fff";that.addHud=function(id,width,height,x,y,cssClass){if(!id||!width||!height||x===undefined||y===undefined){throw"Missing arguments"}var div=document.createElement("div");div.id=id;div.style.position="absolute";div.style.height=height+"px";div.style.width=width+"px";div.style.left=x+"px"||that.defaultPosition.x;div.style.top=y+"px"||that.defaultPosition.y;div.className=cssClass;rootElement.appendChild(div);that.huds[id]=div;return div};that.removeHud=function(id){delete that.huds[id];return(hud=document.getElementById(id)).parentNode.removeChild(hud)};that.clear=function(){rootElement.innerHTML=""};return that}INPUT=function(){that={};var callbacks={};that.addCallback=function(eventType,c){if(!callbacks[eventType]){callbacks[eventType]=[c];var f=function(){for(var i in callbacks[eventType]){try{callbacks[eventType][i].apply(this,arguments)}catch(e){console.log("Could not run input callback "+callbacks[eventType][i]+" Error message was: "+e)}}};if(eventType==="onmousedown"){document.onmousedown=f}else{Mousetrap.bind(eventType,f)}return 0}else{var newIndex=callbacks[eventType].length;callbacks[eventType][newIndex]=c;return newIndex}};that.removeCallback=function(eventType,id){delete callbacks[eventType][id];return null};Mousetrap.bind("b r u t o p i a",cheat);function cheat(e){console.log("Stop trying to cheat!")}return that}();(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}})();